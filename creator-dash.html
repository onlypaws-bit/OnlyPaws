<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OnlyPaws ‚Äî Creator Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- ‚ö†Ô∏è STILI IDENTICI, NON TOCCATI -->
  <style>
    /* ‚Ä¶ [STILI IDENTICI AL TUO FILE, NON MODIFICATI] ‚Ä¶ */
  </style>
</head>

<body>
<div class="wrap">
  <!-- NAV identica -->

  <div class="panel">
    <h1>Creator dashboard</h1>
    <p class="sub">Manage creator tools: posts, audience, and an indicative Stripe balance.</p>

    <!-- STATUS -->
    <div class="card">
      <h3>Status</h3>
      <div class="hint" id="stateBox">Loading‚Ä¶</div>

      <div class="btnRow" style="margin-top:12px;">
        <a class="btn" id="createPostBtn" href="create-post.html" style="pointer-events:none;opacity:.6;">Create post</a>
        <a class="ghost" id="gotoProfileBtn" href="profile.html">View profile</a>
      </div>

      <div class="locked" style="margin-top:12px;">
        <b>Tip</b>
        <div class="hint">Post consistently to grow followers and convert them into subscribers üíú</div>
      </div>
    </div>

    <!-- resto file invariato -->
  </div>
</div>

<script>
/* ========= PATCH FRONT ========= */

async function getCreatorPlanStatus(userId){
  const { data, error } = await onlypawsClient
    .from("entitlements")
    .select("status, current_period_end, cancel_at_period_end, stripe_subscription_id")
    .eq("user_id", userId)
    .eq("key", "creator_plan")
    .maybeSingle();

  if(error) throw error;
  return data;
}

function renderCreatorPlanState(plan){
  const now = Date.now();
  const cpeMs = plan?.current_period_end ? new Date(plan.current_period_end).getTime() : 0;
  const until = plan?.current_period_end
    ? new Date(plan.current_period_end).toLocaleDateString()
    : null;

  if(plan?.cancel_at_period_end && cpeMs > now){
    setState(
      "‚ö†Ô∏è Creator plan canceled",
      `Your plan will end at the end of the billing period.`,
      `
        <div class="btnRow" style="margin-top:12px;">
          <button class="ghost" id="resumePlanBtn">Resume Creator Plan</button>
        </div>
        <div class="hint" style="margin-top:6px;">
          ‚è≥ Active until <b>${until}</b>
        </div>
      `
    );
    enable(createPostBtn, true);
    bindResume();
    return;
  }

  // NORMAL ACTIVE
  setState(
    "‚úÖ Creator unlocked",
    "Plan active. You can create posts and use creator tools.",
    `
      <div class="btnRow" style="margin-top:12px;">
        <button class="ghost danger" id="cancelPlanBtn">Cancel</button>
      </div>
      <div class="hint" style="margin-top:6px;">
        Cancels at the end of your current billing period.
      </div>
    `
  );
  enable(createPostBtn, true);
  bindCancel();
}

function bindCancel(){
  const btn = document.getElementById("cancelPlanBtn");
  if(!btn) return;
  btn.onclick = async () => {
    if(!confirm("Cancel your Creator Plan at the end of the current period?")) return;
    btn.disabled = true;
    btn.textContent = "Processing‚Ä¶";
    await onlypawsClient.functions.invoke("cancel-creator-plan");
    window.location.reload();
  };
}

function bindResume(){
  const btn = document.getElementById("resumePlanBtn");
  if(!btn) return;
  btn.onclick = async () => {
    btn.disabled = true;
    btn.textContent = "Processing‚Ä¶";
    await onlypawsClient.functions.invoke("resume-creator-plan");
    window.location.reload();
  };
}

/* ========= END PATCH ========= */
</script>
</body>
</html>
