<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OnlyPaws ‚Äî Fan Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg1:#6B4EFF;
      --bg2:#8B6CFF;
      --text:#ffffff;
      --muted:rgba(255,255,255,.85);
      --stroke:rgba(255,255,255,.16);
      --card:rgba(0,0,0,.16);
      --btn:#ffffff;
      --btnText:#6B4EFF;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(255,255,255,.18), transparent 55%),
        radial-gradient(1000px 650px at 90% 30%, rgba(0,0,0,.22), transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }
    .wrap{max-width:1040px;margin:0 auto;padding:28px 18px 70px;}

    .nav{display:flex;align-items:center;justify-content:space-between;gap:14px;margin-bottom:28px;flex-wrap:wrap;}
    .brand{display:flex;align-items:center;gap:12px;text-decoration:none;color:white;font-weight:900;}
    .brandLogo{
      width:62px;height:62px;border-radius:14px;
      background: rgba(255,255,255,.16);
      border:1px solid rgba(255,255,255,.18);
      display:flex;align-items:center;justify-content:center;
    }
    .brandLogo img{width:46px;height:46px;object-fit:contain;}
    .brandText{font-size:1.1rem;}

    .navRight{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;}

    .pill{
      padding:8px 14px;border-radius:999px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      font-size:13px;color:rgba(255,255,255,.85);
      white-space:nowrap;
    }

    .navBtn{
      display:inline-flex;align-items:center;justify-content:center;
      padding:10px 14px;border-radius:999px;
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      color:white;text-decoration:none;font-weight:900;
      cursor:pointer;font-size:13px;white-space:nowrap;
      transition:transform .16s ease, background .16s ease;
      user-select:none;
    }
    .navBtn:hover{transform:translateY(-1px);background:rgba(255,255,255,.14)}

    .grid{display:grid;grid-template-columns: 1fr 1fr;gap:16px;}
    @media (max-width: 920px){ .grid{grid-template-columns:1fr;} }

    .panel{
      border-radius:22px;padding:22px;
      background: var(--card);
      border:1px solid var(--stroke);
      backdrop-filter: blur(10px);
      box-shadow:0 20px 45px rgba(0,0,0,.25);
    }
    h1{margin:0 0 6px;font-size: clamp(2rem, 4vw, 2.4rem);letter-spacing:-0.6px;}
    .sub{margin:0;color:var(--muted);line-height:1.55}

    .list{margin-top:14px;display:grid;gap:10px;}
    .item{
      background: rgba(255,255,255,.10);
      transition: background .16s ease, transform .16s ease;
      border:1px solid rgba(255,255,255,.16);
      border-radius:16px;
      padding:12px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .item.clickable{cursor:pointer;}
    .item.clickable:hover{background: rgba(255,255,255,.14);transform:translateY(-1px);}
    .left{min-width:0;display:flex;gap:12px;align-items:center;}
    .avatar{
      width:40px;height:40px;border-radius:14px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.14);
      overflow:hidden;flex:0 0 auto;
      display:flex;align-items:center;justify-content:center;
      font-size:16px;
    }
    .avatar img{width:100%;height:100%;object-fit:cover;display:block;}
    .title{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:420px;}
    .meta{font-size:13px;color:rgba(255,255,255,.82);margin-top:4px}

    .btnRow{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px;}

    /* ghost */
    .ghost{
      padding:12px 16px;border-radius:999px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      color:white;text-decoration:none;font-weight:800;
      cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;
      transition:transform .16s ease, background .16s ease, border-color .16s ease;
      user-select:none;
      white-space:nowrap;
    }
    .ghost:hover{transform:translateY(-1px);background:rgba(255,255,255,.14);border-color:rgba(255,255,255,.22);}
    .ghost:active{transform:translateY(0px) scale(.99);}
    .ghost.danger{
      background: rgba(255, 80, 80, .18);
      border-color: rgba(255, 120, 120, .28);
      color: #ffd1d1;
    }
    .ghost.danger:hover{ background: rgba(255, 80, 80, .26); }
    .ghost[disabled], .ghost.disabled{
      opacity:.45;
      cursor:not-allowed;
      pointer-events:none;
    }

    /* ‚úÖ primary (coerente a creator-profile) */
    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      padding:12px 16px;border-radius:999px;
      background: var(--btn);
      color: var(--btnText);
      text-decoration:none;font-weight:900;border:none;cursor:pointer;
      box-shadow:0 14px 30px rgba(0,0,0,.20);
      transition:transform .16s ease, box-shadow .16s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px) scale(1.01);}
    .btn:active{transform:translateY(0px) scale(.99);}
    .btn:disabled{opacity:.55;cursor:not-allowed;box-shadow:none;}

    .badge{
      font-size:12px;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.14);
      white-space:nowrap;
      font-weight:900;
    }
    .msg{margin-top:10px;font-size:13px;color:rgba(255,255,255,.85);min-height:18px}

    footer{
      margin-top:32px;
      padding-bottom:22px;
      color:rgba(255,255,255,.75);
      font-size:13px;
      text-align:center;
      line-height:1.5;
    }
    .smallLegal{display:inline-block;margin-top:6px;opacity:.85;font-size:12px;}

    .ghost.disabled,
    .ghost[aria-disabled="true"]{
      opacity:.45;
      cursor:not-allowed;
      pointer-events:none;
      filter:saturate(.2);
    }
    .pillSoon{
      margin-left:10px;
      padding:6px 10px;
      font-size:12px;
      font-weight:900;
      letter-spacing:.2px;
      opacity:.9;
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="nav">
    <a href="feed.html" class="brand">
      <div class="brandLogo"><img src="logo.png" alt="OnlyPaws logo"></div>
      <span class="brandText">OnlyPaws</span>
    </a>

    <div class="navRight">
      <div class="pill" id="userPill">‚Ä¶</div>
      <a class="navBtn" href="profile.html">Profile</a>
      <button class="navBtn" id="logoutBtn" type="button">Log out</button>
    </div>
  </div>

  <div class="panel" style="margin-bottom:16px;">
    <h1>Fan Dashboard</h1>
    <p class="sub">Manage your subscriptions, follows, and access.</p>
    <div class="msg" id="topMsg"></div>
  </div>

  <div class="grid">
    <div class="panel">
      <div class="pill">My Subscriptions</div>
      <p class="sub" style="margin-top:10px;">
        Cancel anytime. Access remains active until the end of the billing period.
      </p>
      <div class="list" id="subsList"></div>
      <div class="msg" id="subsMsg"></div>
    </div>

    <div class="panel">
      <div class="pill">Following</div>
      <p class="sub" style="margin-top:10px;">Creators you follow.</p>
      <div class="list" id="followsList"></div>
      <div class="msg" id="followsMsg"></div>
    </div>

    <div class="panel" style="grid-column:1/-1;">
      <div class="pill">My Access</div>
      <p class="sub" style="margin-top:10px;">Shortcuts to what you can view.</p>
      <div class="btnRow">
        <button class="ghost disabled" type="button" disabled aria-disabled="true" title="Coming soon: Purchased posts">
          View purchased posts <span class="pill pillSoon">Soon</span>
        </button>
      </div>
    </div>
  </div>
</div>

<footer>
  ¬© 2026 OnlyPaws ‚Ä¢ Built with toe beans energy üêæ<br/>
  <span class="smallLegal">OnlyPaws is an independent digital platform. Features may evolve over time.</span>
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>

<script>
  const userPill = document.getElementById("userPill");
  const topMsg = document.getElementById("topMsg");

  const subsList = document.getElementById("subsList");
  const subsMsg  = document.getElementById("subsMsg");

  const followsList = document.getElementById("followsList");
  const followsMsg  = document.getElementById("followsMsg");

  let CURRENT_USER_ID = null;

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function emptyItem(title, meta){
    return `
      <div class="item">
        <div class="left">
          <div class="avatar">üêæ</div>
          <div style="min-width:0;">
            <div class="title">${esc(title)}</div>
            <div class="meta">${esc(meta || "")}</div>
          </div>
        </div>
        <span class="badge">‚Äî</span>
      </div>
    `;
  }

  async function requireSession(){
    const { data } = await onlypawsClient.auth.getSession();
    if(!data?.session){
      window.location.href = "fans.html?next=fan-dash.html";
      return null;
    }
    return data.session;
  }

  async function hydrateUserPill(){
    try{
      const { data: sessData } = await onlypawsClient.auth.getSession();
      const session = sessData?.session;
      if(!session){ userPill.textContent = "Guest"; return; }

      const uid = session.user.id;
      const email = session.user.email || "";

      const { data: prof } = await onlypawsClient
        .from("profiles")
        .select("username, display_name")
        .eq("user_id", uid)
        .maybeSingle();

      const uname = (prof?.username || "").trim();
      const dname = (prof?.display_name || "").trim();

      if(uname) userPill.textContent = "@" + uname;
      else if(dname) userPill.textContent = dname;
      else if(email) userPill.textContent = email.split("@")[0];
      else userPill.textContent = "User";
    }catch(e){}
  }

  function creatorLink(username){
    const u = (username || "").replace(/^@/,"").trim();
    return `creator-profile.html?u=${encodeURIComponent(u)}`;
  }

  async function unfollowCreator(followId, creatorLabel){
    if(!followId) return;
    const label = (creatorLabel || "this creator");
    if(!confirm(`Unfollow ${label}?`)) return;

    followsMsg.textContent = "Unfollowing‚Ä¶";
    try{
      const { error } = await onlypawsClient
        .from("followers")
        .delete()
        .eq("id", followId);

      if(error) throw error;

      followsMsg.textContent = "Unfollowed.";
      if(CURRENT_USER_ID) await loadFollowing(CURRENT_USER_ID);
      followsMsg.textContent = "";
    }catch(e){
      console.error(e);
      followsMsg.textContent = "‚ùå Error unfollowing. Check logs.";
    }
  }

  async function loadFollowing(userId){
    followsMsg.textContent = "Loading‚Ä¶";
    followsList.innerHTML = "";

    const { data, error } = await onlypawsClient
      .from("followers")
      .select(`
        id,
        created_at,
        creator:creator_id (
          user_id,
          username,
          display_name,
          avatar_url
        )
      `)
      .eq("fan_id", userId)
      .order("created_at", { ascending:false });

    if(error){
      followsMsg.textContent = "‚ùå " + error.message;
      followsList.innerHTML = "";
      return;
    }

    if(!data || data.length === 0){
      followsMsg.textContent = "";
      followsList.innerHTML = emptyItem("No follows yet", "Follow a creator and they will appear here.");
      return;
    }

    followsMsg.textContent = "";
    followsList.innerHTML = "";

    for(const row of data){
      const c = row.creator;
      const uname = (c?.username || "").trim();
      const dname = (c?.display_name || "").trim() || uname || "Creator";
      const avatar = (c?.avatar_url || "").trim();

      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="left">
          <div class="avatar">${avatar ? `<img src="${esc(avatar)}" alt="avatar">` : "üêæ"}</div>
          <div style="min-width:0;">
            <div class="title">${esc(dname)}</div>
            <div class="meta">${uname ? "@" + esc(uname) : ""}</div>
          </div>
        </div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;">
          <button class="ghost danger" type="button" data-unfollow-id="${esc(row.id)}" data-unfollow-label="${esc(dname)}">Unfollow</button>
        </div>
      `;

      // row clickable
      const openUrl = creatorLink(uname);
      if(uname){
        el.classList.add("clickable");
        el.addEventListener("click", () => {
          window.location.href = openUrl;
        });
      }

      // unfollow
      const ubtn = el.querySelector("[data-unfollow-id]");
      if(ubtn){
        ubtn.addEventListener("click", (ev) => {
          ev.stopPropagation();
          const followId = ubtn.getAttribute("data-unfollow-id");
          const label = ubtn.getAttribute("data-unfollow-label") || "";
          unfollowCreator(followId, label);
        });
      }

      followsList.appendChild(el);
    }
  }

  async function cancelSubscription(stripeSubId, creatorLabel){
    if(!stripeSubId) return;
    const label = creatorLabel ? ` to ${creatorLabel}` : "";
    if(!confirm(`Cancel subscription${label}? Access remains active until the end of the billing period.`)) return;

    subsMsg.textContent = "Cancelling‚Ä¶";
    try{
      const { data: s } = await onlypawsClient.auth.getSession();
      const token = s?.session?.access_token;
      if(!token) throw new Error("No session");

      const { error } = await onlypawsClient.functions.invoke("cancel-subscription", {
        body: { stripe_subscription_id: stripeSubId },
        headers: { Authorization: `Bearer ${token}` },
      });

      if(error) throw error;

      subsMsg.textContent = "Cancellation requested. Updating‚Ä¶";
      await loadSubscriptions(s.session.user.id);
      subsMsg.textContent = "Done. Access remains until period end.";
    }catch(e){
      console.error(e);
      subsMsg.textContent = "‚ùå Error canceling subscription. Check logs.";
    }
  }

  async function resumeSubscription(stripeSubId, creatorLabel){
    if(!stripeSubId) return;
    const label = creatorLabel ? ` to ${creatorLabel}` : "";
    if(!confirm(`Resume subscription${label}?`)) return;

    subsMsg.textContent = "Resuming‚Ä¶";
    try{
      const { data: s } = await onlypawsClient.auth.getSession();
      const token = s?.session?.access_token;
      if(!token) throw new Error("No session");

      const { error } = await onlypawsClient.functions.invoke("resume-subscription", {
        body: { stripe_subscription_id: stripeSubId },
        headers: { Authorization: `Bearer ${token}` },
      });

      if(error) throw error;

      subsMsg.textContent = "Subscription resumed. Updating‚Ä¶";
      await loadSubscriptions(s.session.user.id);
      subsMsg.textContent = "";
    }catch(e){
      console.error(e);
      subsMsg.textContent = "‚ùå Error resuming subscription. Check logs.";
    }
  }

  async function loadSubscriptions(userId){
    subsMsg.textContent = "Loading‚Ä¶";
    subsList.innerHTML = "";

    const { data: rows, error } = await onlypawsClient
      .from("creator_subscriptions")
      .select("creator_id,status,is_active,created_at,current_period_end,stripe_subscription_id,cancel_at_period_end")
      .eq("fan_id", userId)
      .eq("is_active", true)
      .order("created_at", { ascending:false });

    if(error){
      subsMsg.textContent = "‚ùå " + error.message;
      subsList.innerHTML = "";
      return;
    }

    if(!rows || rows.length === 0){
      subsMsg.textContent = "";
      subsList.innerHTML = emptyItem("No subscriptions yet", "When you subscribe to a creator, it will appear here.");
      return;
    }

    // load creator profiles (username/avatar)
    const creatorIds = Array.from(new Set(rows.map(r => r.creator_id).filter(Boolean)));
    const { data: profs, error: pErr } = await onlypawsClient
      .from("profiles")
      .select("user_id, username, display_name, avatar_url")
      .in("user_id", creatorIds);

    const pMap = new Map();
    if(!pErr && Array.isArray(profs)){
      for(const p of profs) pMap.set(p.user_id, p);
    }

    subsMsg.textContent = "";
    subsList.innerHTML = "";

    const now = Date.now();

    for(const row of rows){
      const c = pMap.get(row.creator_id) || {};
      const uname = (c?.username || "").trim();
      const dname = (c?.display_name || "").trim() || (uname ? ("@" + uname) : "") || "Creator";
      const avatar = (c?.avatar_url || "").trim();

      const status = (row.status || "active").toString().toLowerCase();

      const periodEndMs = row.current_period_end
        ? new Date(row.current_period_end).getTime()
        : 0;

      const hasAccess = !!periodEndMs && periodEndMs > now;

      // ‚úÖ Stripe cancel_at_period_end is the real signal for scheduled cancellation
      const isCanceling = hasAccess && (row.cancel_at_period_end === true);

      let badgeText = "Active";
      if(status === "past_due") badgeText = "Past due";
      else if(isCanceling) badgeText = "Canceling";
      else if(!hasAccess) badgeText = "Expired";

      const until = row.current_period_end ? new Date(row.current_period_end).toLocaleDateString() : null;

      const metaLine = [
        uname ? ("@" + uname) : "",
        until ? ("until " + until) : ""
      ].filter(Boolean).join(" ‚Ä¢ ");

      const canCancel =
        hasAccess &&
        status === "active" &&
        (row.cancel_at_period_end !== true) &&
        row.stripe_subscription_id;

      const canResume =
        hasAccess &&
        (row.cancel_at_period_end === true) &&
        row.stripe_subscription_id;

      let actionHtml = "";
      if(canCancel){
        actionHtml = `<button class="ghost danger" type="button" data-cancel-sub="${esc(row.stripe_subscription_id)}" data-cancel-label="${esc(dname)}">Cancel</button>`;
      }else if(canResume){
        actionHtml = `<button class="btn" type="button" data-resume-sub="${esc(row.stripe_subscription_id)}" data-resume-label="${esc(dname)}">Resume subscription</button>`;
      }

      const canOpen = !!uname;
      const uParam = encodeURIComponent(uname || "");

      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="left">
          <div class="avatar">${avatar ? `<img src="${esc(avatar)}" alt="avatar">` : "üêæ"}</div>
          <div style="min-width:0;">
            <div class="title">${esc(dname)}</div>
            <div class="meta">${esc(metaLine)}</div>
          </div>
        </div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;">
          <span class="badge">${esc(badgeText)}</span>
          ${actionHtml}
        </div>
      `;

      // cancel
      const cbtn = el.querySelector("[data-cancel-sub]");
      if(cbtn){
        cbtn.addEventListener("click", (ev) => {
          ev.stopPropagation();
          const subId = cbtn.getAttribute("data-cancel-sub");
          const label = cbtn.getAttribute("data-cancel-label") || "";
          cancelSubscription(subId, label);
        });
      }

      // resume
      const rbtn = el.querySelector("[data-resume-sub]");
      if(rbtn){
        rbtn.addEventListener("click", (ev) => {
          ev.stopPropagation();
          const subId = rbtn.getAttribute("data-resume-sub");
          const label = rbtn.getAttribute("data-resume-label") || "";
          resumeSubscription(subId, label);
        });
      }

      // row clickable
      const openUrl = canOpen ? `creator-profile.html?u=${uParam}` : null;
      if(openUrl){
        el.classList.add("clickable");
        el.addEventListener("click", () => {
          window.location.href = openUrl;
        });
      }

      subsList.appendChild(el);
    }
  }

  document.getElementById("logoutBtn").addEventListener("click", async () => {
    try{ await onlypawsClient.auth.signOut(); }catch(e){}
    window.location.href = "index.html";
  });

  (async () => {
    if(typeof onlypawsClient === "undefined"){
      topMsg.textContent = "‚ùå onlypawsClient not found. Check supabase.js.";
      return;
    }

    const session = await requireSession();
    if(!session) return;

    CURRENT_USER_ID = session.user.id;

    await hydrateUserPill();

    await Promise.all([
      loadFollowing(session.user.id),
      loadSubscriptions(session.user.id),
    ]);
  })();
</script>

</body>
</html>
