<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OnlyPaws ‚Äî Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --bg1:#6B4EFF; --bg2:#8B6CFF; --text:#fff;
      --muted:rgba(255,255,255,.85);
      --stroke:rgba(255,255,255,.16);
      --card:rgba(0,0,0,.16);
      --btn:#fff; --btnText:#6B4EFF;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Arial,sans-serif; color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(255,255,255,.18), transparent 55%),
        radial-gradient(1000px 650px at 90% 30%, rgba(0,0,0,.22), transparent 55%),
        linear-gradient(135deg,var(--bg1),var(--bg2));
      min-height:100vh;
    }
    .wrap{max-width:900px;margin:0 auto;padding:28px 18px 70px;}
    .nav{display:flex;align-items:center;justify-content:space-between;gap:14px;margin-bottom:18px;}
    .brand{display:flex;align-items:center;gap:12px;text-decoration:none;color:white;font-weight:900;}
    .brandLogo{width:62px;height:62px;border-radius:14px;background:rgba(255,255,255,.16);border:1px solid rgba(255,255,255,.18);display:flex;align-items:center;justify-content:center;}
    .brandLogo img{width:46px;height:46px;object-fit:contain;}
    .pill{padding:10px 14px;border-radius:999px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);font-size:13px;}
    .navRight{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
    .navBtn{
      display:inline-flex;align-items:center;justify-content:center;
      padding:10px 14px;border-radius:999px;
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      color:white;text-decoration:none;font-weight:900;
      cursor:pointer; user-select:none;
      transition: transform .16s ease, background .16s ease, border-color .16s ease;
      font-size:13px; white-space:nowrap;
    }
    .navBtn:hover{transform: translateY(-1px); background: rgba(255,255,255,.14); border-color: rgba(255,255,255,.22);}
    .navBtn:active{transform: translateY(0px) scale(.99);}

    .panel{border-radius:22px;padding:22px;background:var(--card);border:1px solid var(--stroke);backdrop-filter:blur(10px);}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    h1{margin:10px 0;font-size:2.2rem;}
    .sub{margin:0;color:var(--muted);}
    .field{margin-top:12px;}
    label{display:block;font-size:13px;margin-bottom:6px;}
    input, textarea{
      width:100%; padding:12px; border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.12); color:white;
      outline:none;
    }
    input[type="file"]{padding:10px 12px}
    textarea{min-height:110px;}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;align-items:center;}
    .btn{padding:12px 16px;border-radius:999px;background:#fff;color:#6B4EFF;font-weight:900;border:none;cursor:pointer;}
    .btn:disabled{opacity:.6;cursor:not-allowed;}
    .ghost{
      padding:12px 16px;border-radius:999px;
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      color:white;cursor:pointer;text-decoration:none;
      display:inline-flex;align-items:center;justify-content:center;
    }
    .msg{margin-top:10px;min-height:18px;font-size:13px;white-space:pre-wrap;}
    .avatarBox{margin-top:12px;padding:14px;border-radius:18px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.16);display:flex;gap:14px;flex-wrap:wrap;}
    .avatarImg{width:74px;height:74px;border-radius:22px;object-fit:cover;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.18);}
    .dangerZone{margin-top:16px;padding:14px;border-radius:18px;background:rgba(0,0,0,.14);border:1px solid rgba(255,120,120,.35);}
    .dangerBtn{border-color:rgba(255,120,120,.55)!important;}

    .uploadHint{
      margin-top:8px;
      padding:10px 12px;
      border-radius:14px;
      background: rgba(0,0,0,.14);
      border:1px solid rgba(255,255,255,.14);
      font-size:12px;
      color: rgba(255,255,255,.82);
      line-height:1.45;
    }

    /* ‚úÖ NEW: username hint */
    .hint{
      margin-top:8px;
      padding:10px 12px;
      border-radius:14px;
      background: rgba(0,0,0,.14);
      border:1px solid rgba(255,255,255,.14);
      font-size:12px;
      color: rgba(255,255,255,.82);
      line-height:1.45;
      white-space:pre-wrap;
    }
    .hint.ok{border-color: rgba(170,255,200,.35);}
    .hint.bad{border-color: rgba(255,170,170,.45);}
    
/* ===== GLOBAL FOOTER ===== */

.globalFooter {
  text-align: center;
  padding: 30px 20px;
  font-size: 14px;
  opacity: 0.9;
  line-height: 1.6;
}

/* Seconda frase descrittiva */
.globalFooter .small {
  margin-top: 6px;
  font-size: 13px;
  opacity: 0.8;
}

/* Spazio tra frase e link */
.globalFooter .footerLinks {
  margin-top: 14px;
}

/* Link footer */
.globalFooter a {
  color: rgba(255,255,255,0.9);
  text-decoration: none;
  opacity: 0.85;
  transition: opacity 0.2s ease, text-decoration 0.2s ease;
}

/* Hover */
.globalFooter a:hover {
  text-decoration: underline;
  opacity: 1;
}

.small{
  font-size:12px;
  opacity:.85;
  margin-top:6px;
}
  </style>
</head>

<body>
<div class="wrap">
  <div class="nav">
    <a href="feed.html" class="brand">
      <div class="brandLogo"><img src="logo.png"></div>
      <span>OnlyPaws</span>
    </a>

    <div class="navRight">
      <div class="pill" id="userPill">‚Ä¶</div>

      <a class="navBtn" id="dashTopLink" href="#" style="display:none;">Dashboard</a>
      <button class="navBtn" id="logoutBtn" type="button">Log out</button>
    </div>
  </div>

  <div class="panel">
    <div class="row">
      <div>
        <div class="pill" id="emailPill">‚Ä¶</div>
        <h1>Your profile</h1>
        <p class="sub">Set your basics + avatar.</p>
      </div>
    </div>

    <div class="field">
      <label>Email</label>
      <input id="email" readonly />
    </div>

    <div class="avatarBox">
      <img id="avatarImg" class="avatarImg" alt="Avatar">
      <div style="flex:1; min-width:220px;">
        <input id="avatarFile" type="file" accept="image/*">
        <div class="btnRow">
          <button class="ghost" id="uploadAvatarBtn" type="button">Upload</button>
          <button class="ghost" id="removeAvatarBtn" type="button">Remove</button>
        </div>
        <div class="uploadHint" id="avatarHint"></div>
      </div>
    </div>

    <div class="field"><label>Display name</label><input id="display_name"></div>

    <div class="field">
      <label>Username</label>
      <input id="username" autocomplete="off" />
      <!-- ‚úÖ NEW: hint under username -->
      <div class="hint" id="usernameHint"></div>
    </div>

    <div class="field"><label>Bio</label><textarea id="bio"></textarea></div>

    <div class="btnRow">
      <button class="btn" id="saveBtn" type="button">Save profile</button>
    </div>
    <div class="msg" id="msg"></div>

    <div class="dangerZone">
      <b>Danger zone</b>
      <div class="btnRow">
        <button class="ghost dangerBtn" id="deleteBtn" type="button">Delete account</button>
      </div>
      <div class="msg" id="deleteMsg"></div>
    </div>
  </div>

  <footer class="globalFooter">
  <div class="footerTop">
    ¬© 2026 OnlyPaws ‚Ä¢ Built with toe beans energy üêæ
  </div>

  <div class="small">
    OnlyPaws is an independent digital platform. Features may evolve over time.
  </div>

  <div class="footerLinks">
    <a href="content-policy.html">Content Policy</a>
    &nbsp;¬∑&nbsp;
    <a href="privacy-policy.html">Privacy Policy</a>
    &nbsp;¬∑&nbsp;
    <a href="terms.html">Terms of Service</a>
    &nbsp;¬∑&nbsp;
    <a href="mailto:onlypawssupp@gmail.com">Contact Us</a>
  </div>
</footer>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>

<script>
  const AVATAR_BUCKET = "avatars";

  const msg = document.getElementById("msg");
  const deleteMsg = document.getElementById("deleteMsg");
  const deleteBtn = document.getElementById("deleteBtn");

  const emailPill = document.getElementById("emailPill");
  const userPill = document.getElementById("userPill");

  const emailEl = document.getElementById("email");
  const displayNameEl = document.getElementById("display_name");
  const usernameEl = document.getElementById("username");
  const bioEl = document.getElementById("bio");

  const saveBtn = document.getElementById("saveBtn");

  const avatarImg = document.getElementById("avatarImg");
  const avatarFile = document.getElementById("avatarFile");
  const uploadAvatarBtn = document.getElementById("uploadAvatarBtn");
  const removeAvatarBtn = document.getElementById("removeAvatarBtn");
  const avatarHint = document.getElementById("avatarHint");

  const logoutBtn = document.getElementById("logoutBtn");
  const dashTopLink = document.getElementById("dashTopLink");

  // ‚úÖ NEW: username hint element
  const usernameHint = document.getElementById("usernameHint");

  function setMsg(t){ msg.textContent = t || ""; }
  function setDeleteMsg(t){ deleteMsg.textContent = t || ""; }
  function setHint(t){ avatarHint.textContent = t || ""; }

  // ‚úÖ NEW: username rules aligned with DB
  const USERNAME_RE = /^[a-z0-9._]{3,24}$/;
  const HAS_LETTER_RE = /[a-z]/;

  function normalizeUsername(v){
    return String(v || "").trim().toLowerCase();
  }

  function setUsernameHint(ok, text){
    if(!usernameHint) return;
    usernameHint.textContent = text || "";
    usernameHint.classList.toggle("ok", !!ok);
    usernameHint.classList.toggle("bad", !ok);
  }

  function validateUsername(vRaw){
    const v = normalizeUsername(vRaw);

    if(!v){
      return { ok:false, v, msg: "Username required.\nAllowed: a‚Äìz, 0‚Äì9, '.', '_' (3‚Äì24 chars). Must include at least one letter." };
    }
    if(v.length < 3){
      return { ok:false, v, msg: "Too short (min 3 characters)." };
    }
    if(v.length > 24){
      return { ok:false, v, msg: "Too long (max 24 characters)." };
    }
    if(!USERNAME_RE.test(v)){
      return { ok:false, v, msg: "Invalid characters.\nAllowed: lowercase letters, numbers, '.', '_' only." };
    }
    if(!HAS_LETTER_RE.test(v)){
      return { ok:false, v, msg: "Must include at least one letter (a‚Äìz)." };
    }
    return { ok:true, v, msg: "Looks good ‚úÖ" };
  }

  function refreshUsernameUI(){
    const res = validateUsername(usernameEl.value);

    // keep it normalized (lowercase/trim) but do NOT replace '.' or '_' (DB allows them)
    if(usernameEl.value !== res.v){
      // try to preserve cursor reasonably
      const start = usernameEl.selectionStart;
      const end = usernameEl.selectionEnd;
      usernameEl.value = res.v;
      if(start != null && end != null){
        try{ usernameEl.setSelectionRange(start, end); }catch(e){}
      }
    }

    setUsernameHint(res.ok, res.msg);
    saveBtn.disabled = !res.ok;
    return res;
  }

  function hydrateUserPillFromProfile(prof, email){
    try{
      const uname = (prof?.username || "").trim();
      const dname = (prof?.display_name || "").trim();

      if(uname){
        userPill.textContent = "@" + uname;
      }else if(dname){
        userPill.textContent = dname;
      }else if(email){
        userPill.textContent = email.split("@")[0];
      }else{
        userPill.textContent = "User";
      }
    }catch(e){}
  }

  function goIndex(){
    window.location.replace("index.html");
  }

  // ‚úÖ NEW: guard contro sessione fantasma / user eliminato
  async function guardAuthOrRedirect(){
    try{
      const { data: sessData } = await onlypawsClient.auth.getSession();
      const session = sessData?.session;
      if(!session){
        goIndex();
        return null;
      }

      // Se auth user non esiste pi√π (account eliminato) ‚Üí pulisci e torna a index
      const { data: u, error: uErr } = await onlypawsClient.auth.getUser();
      const user = u?.user;
      if(uErr || !user){
        try{ await onlypawsClient.auth.signOut(); }catch(e){}
        goIndex();
        return null;
      }

      return user;
    }catch(e){
      try{ await onlypawsClient.auth.signOut(); }catch(_){}
      goIndex();
      return null;
    }
  }

  // ‚úÖ NEW: se la session cambia mentre sei dentro, butta fuori
  try{
    onlypawsClient.auth.onAuthStateChange((_event, session) => {
      if(!session) goIndex();
    });
  }catch(e){}

  function fileExt(name){
    const m = String(name || "").toLowerCase().match(/\.(\w+)$/);
    return m ? m[1] : "png";
  }

  async function uploadAvatarToBucket(file, userId){
    const ext = fileExt(file.name);
    const safeName = `${Date.now()}-${Math.random().toString(16).slice(2)}.${ext}`;
    const path = `${userId}/${safeName}`;

    const { error: upErr } = await onlypawsClient
      .storage
      .from(AVATAR_BUCKET)
      .upload(path, file, { upsert: true });

    if(upErr) throw upErr;

    const { data } = onlypawsClient
      .storage
      .from(AVATAR_BUCKET)
      .getPublicUrl(path);

    const url = data?.publicUrl;
    if(!url) throw new Error("Could not get public URL for uploaded file.");
    return url;
  }

  async function loadProfile(){
    setMsg("");

    const user = await guardAuthOrRedirect();
    if(!user) return;

    const email = user?.email || "";
    emailEl.value = email;
    emailPill.textContent = email || "‚Ä¶";

    let { data: prof, error } = await onlypawsClient
      .from("profiles")
      .select("user_id, display_name, username, bio, role, avatar_url")
      .eq("user_id", user.id)
      .maybeSingle();

    if(error){
      setMsg("‚ùå Load profile error: " + error.message);
      return;
    }

    if(!prof){
      const { error: insErr } = await onlypawsClient
        .from("profiles")
        .upsert({ user_id: user.id, role: "fan" }, { onConflict: "user_id" });

      if(insErr){
        // FK qui = user non esiste pi√π ‚Üí fuori
        if(String(insErr.message || "").toLowerCase().includes("foreign key")){
          try{ await onlypawsClient.auth.signOut(); }catch(e){}
          goIndex();
          return;
        }
        setMsg("‚ùå Could not create profile: " + insErr.message);
        return;
      }

      const again = await onlypawsClient
        .from("profiles")
        .select("user_id, display_name, username, bio, role, avatar_url")
        .eq("user_id", user.id)
        .maybeSingle();

      if(again.error){
        setMsg("‚ùå Load profile error: " + again.error.message);
        return;
      }
      prof = again.data;
    }

    const role = prof?.role || "fan";
    hydrateUserPillFromProfile(prof, email);

    // Dashboard only top-right everywhere
    dashTopLink.style.display = "inline-flex";
    dashTopLink.href = (role === "creator") ? "creator-dash.html" : "fan-dash.html";

    displayNameEl.value = prof?.display_name || "";
    usernameEl.value = prof?.username || "";
    bioEl.value = prof?.bio || "";

    const a = (prof?.avatar_url || "").trim();
    avatarImg.src = a ? a : "logo.png";

    setHint("Upload an image to change your avatar.");

    // ‚úÖ NEW: run username validation after hydrate
    refreshUsernameUI();
  }

  async function saveProfile(){
    setMsg("");

    const user = await guardAuthOrRedirect();
    if(!user) return;

    // ‚úÖ NEW: validate before save
    const v = refreshUsernameUI();
    if(!v.ok){
      setMsg("‚ùå Fix username before saving.");
      return;
    }

    saveBtn.disabled = true;
    setMsg("Saving‚Ä¶");

    try{
      const payload = {
        user_id: user.id,
        display_name: (displayNameEl.value || "").trim(),
        username: v.v, // normalized + validated
        bio: (bioEl.value || "").trim()
      };

      // ‚úÖ changed: upsert (se il profilo √® stato eliminato, lo ricrea)
      const { error } = await onlypawsClient
        .from("profiles")
        .upsert(payload, { onConflict: "user_id" });

      if(error) throw error;

      setMsg("Saved ‚úÖ");
      await loadProfile();
    }catch(e){
      const code = e?.code || "";
      const m = (e?.message || String(e));

      if(String(m).toLowerCase().includes("foreign key")){
        try{ await onlypawsClient.auth.signOut(); }catch(_){}
        goIndex();
        return;
      }

      // ‚úÖ NEW: friendly duplicate username
      const mm = String(m).toLowerCase();
      if(code === "23505" || mm.includes("duplicate key") || mm.includes("profiles_username_unique")){
        setMsg("‚ùå Username already taken. Try a different one.");
        return;
      }

      // ‚úÖ NEW: friendly format/blank constraint errors
      if(code === "23514" || mm.includes("profiles_username_format") || mm.includes("profiles_username_not_blank")){
        setMsg("‚ùå Invalid username. Allowed: a‚Äìz, 0‚Äì9, '.', '_' (3‚Äì24). Must include at least one letter.");
        return;
      }

      setMsg("‚ùå " + m);
    }finally{
      // if username invalid, keep disabled
      const vv = refreshUsernameUI();
      if(vv.ok) saveBtn.disabled = false;
    }
  }

  // ‚úÖ NEW: live validate username
  usernameEl.addEventListener("input", refreshUsernameUI);
  usernameEl.addEventListener("blur", refreshUsernameUI);

  uploadAvatarBtn.addEventListener("click", async () => {
    setMsg("");

    const user = await guardAuthOrRedirect();
    if(!user) return;

    if(!avatarFile.files || !avatarFile.files[0]){
      alert("Pick an image first.");
      return;
    }

    uploadAvatarBtn.disabled = true;
    uploadAvatarBtn.textContent = "Uploading‚Ä¶";
    setHint("Uploading‚Ä¶");

    try{
      const file = avatarFile.files[0];
      const url = await uploadAvatarToBucket(file, user.id);

      const { error } = await onlypawsClient
        .from("profiles")
        .upsert({ user_id: user.id, avatar_url: url }, { onConflict: "user_id" });

      if(error) throw error;

      avatarImg.src = url;
      avatarFile.value = "";
      setHint("Uploaded ‚úÖ");
      setMsg("Avatar updated ‚úÖ");
    }catch(e){
      const m = (e?.message || String(e));
      if(String(m).toLowerCase().includes("foreign key")){
        try{ await onlypawsClient.auth.signOut(); }catch(_){}
        goIndex();
        return;
      }
      setHint("Upload failed");
      setMsg("‚ùå " + m);
    }finally{
      uploadAvatarBtn.disabled = false;
      uploadAvatarBtn.textContent = "Upload";
    }
  });

  removeAvatarBtn.addEventListener("click", async () => {
    setMsg("");

    const user = await guardAuthOrRedirect();
    if(!user) return;

    try{
      const { error } = await onlypawsClient
        .from("profiles")
        .upsert({ user_id: user.id, avatar_url: null }, { onConflict: "user_id" });
      if(error) throw error;

      avatarImg.src = "logo.png";
      setHint("Removed ‚úÖ");
      setMsg("Avatar removed ‚úÖ");
    }catch(e){
      const m = (e?.message || String(e));
      if(String(m).toLowerCase().includes("foreign key")){
        try{ await onlypawsClient.auth.signOut(); }catch(_){}
        goIndex();
        return;
      }
      setMsg("‚ùå " + m);
    }
  });

  async function deleteAccount(){
    setDeleteMsg("");

    if(!confirm("Delete account permanently?")) return;
    if(prompt("Type DELETE to confirm") !== "DELETE"){
      setDeleteMsg("Cancelled.");
      return;
    }

    deleteBtn.disabled = true;
    setDeleteMsg("Deleting‚Ä¶");

    try{
      const user = await guardAuthOrRedirect();
      if(!user) return;

      const { error } = await onlypawsClient.functions.invoke("delete-profile", {
        body: { confirm: true },
      });
      if(error) throw error;

      try { await onlypawsClient.auth.signOut(); } catch(e) {}
      goIndex();
    }catch(e){
      setDeleteMsg("‚ùå " + (e?.message || String(e)));
      deleteBtn.disabled = false;
    }
  }

  deleteBtn.addEventListener("click", deleteAccount);

  logoutBtn.addEventListener("click", async () => {
    try{ await onlypawsClient.auth.signOut(); }catch(e){}
    goIndex();
  });

  saveBtn.addEventListener("click", saveProfile);

  loadProfile();
</script>
</body>
</html>