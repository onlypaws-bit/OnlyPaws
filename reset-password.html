<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OnlyPaws ‚Äî Reset Password</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>

  <style>
    :root{
      --bg1:#6B4EFF; --bg2:#8B6CFF; --text:#fff;
      --muted:rgba(255,255,255,.85);
      --stroke:rgba(255,255,255,.16);
      --card:rgba(0,0,0,.16);
      --btn:#fff; --btnText:#6B4EFF;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Arial,sans-serif; color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(255,255,255,.18), transparent 55%),
        radial-gradient(1000px 650px at 90% 30%, rgba(0,0,0,.22), transparent 55%),
        linear-gradient(135deg,var(--bg1),var(--bg2));
      min-height:100vh;
      display:grid;
      place-items:center;
      padding:24px;
    }
    .card{
      width:100%;
      max-width:520px;
      border-radius:22px;
      padding:22px;
      background:var(--card);
      border:1px solid var(--stroke);
      backdrop-filter: blur(10px);
      box-shadow:0 20px 45px rgba(0,0,0,.25);
    }
    h1{margin:6px 0 10px;letter-spacing:-.6px;}
    p{margin:0;color:var(--muted);line-height:1.5;}
    input{
      width:100%;
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.12);
      color:white;
      outline:none;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;align-items:center;}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      padding:12px 16px;border-radius:999px;
      background:var(--btn);color:var(--btnText);
      text-decoration:none;font-weight:900;border:none;cursor:pointer;
      box-shadow:0 14px 30px rgba(0,0,0,.22);
    }
    .ghost{
      display:inline-flex;align-items:center;justify-content:center;
      padding:12px 16px;border-radius:999px;
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      color:white;text-decoration:none;font-weight:800;cursor:pointer;
    }
    .msg{margin-top:10px;min-height:18px;color:rgba(255,255,255,.85);font-size:13px;white-space:pre-wrap;}
    .tiny{
      margin-top:10px;
      font-size:12px;
      color:rgba(255,255,255,.75);
      line-height:1.4;
    }
    .hint{
      margin-top:8px;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(0,0,0,.14);
      border:1px solid rgba(255,255,255,.14);
      color:rgba(255,255,255,.82);
      font-size:12px;
      line-height:1.45;
      display:none;
    }

/* ===== GLOBAL FOOTER ===== */

.globalFooter {
  text-align: center;
  padding: 30px 20px;
  font-size: 14px;
  opacity: 0.9;
  line-height: 1.6;
}

/* Seconda frase descrittiva */
.globalFooter .small {
  margin-top: 6px;
  font-size: 13px;
  opacity: 0.8;
}

/* Spazio tra frase e link */
.globalFooter .footerLinks {
  margin-top: 14px;
}

/* Link footer */
.globalFooter a {
  color: rgba(255,255,255,0.9);
  text-decoration: none;
  opacity: 0.85;
  transition: opacity 0.2s ease, text-decoration 0.2s ease;
}

/* Hover */
.globalFooter a:hover {
  text-decoration: underline;
  opacity: 1;
}

  </style>
</head>

<body>
  <div class="card">
    <div style="font-size:40px;">üîê</div>
    <h1>Reset your password</h1>
    <p>Enter a new password for your account.</p>

    <div class="hint" id="hint"></div>

    <input id="newPass" type="password" placeholder="New password (min 6 chars)" autocomplete="new-password" />
    <input id="newPass2" type="password" placeholder="Repeat new password" autocomplete="new-password" />

    <div class="row">
      <button class="btn" id="saveBtn" type="button">Update password</button>
      <a class="ghost" href="index.html">Back to login</a>
    </div>

    <div class="msg" id="msg"></div>
    <div class="tiny">If this link is expired, go back and request a new reset email.</div>
  </div>

<footer class="globalFooter">
  <div class="footerTop">
    ¬© 2026 OnlyPaws ‚Ä¢ Built with toe beans energy üêæ
  </div>

  <div class="small">
    OnlyPaws is an independent digital platform. Features may evolve over time.
  </div>

  <div class="footerLinks">
    <a href="content-policy.html">Content Policy</a>
    &nbsp;¬∑&nbsp;
    <a href="privacy-policy.html">Privacy Policy</a>
    &nbsp;¬∑&nbsp;
    <a href="terms.html">Terms of Service</a>
    &nbsp;¬∑&nbsp;
    <a href="mailto:onlypawssupp@gmail.com">Contact Us</a>
  </div>
</footer>

  <script>
    const msg = document.getElementById("msg");
    const hint = document.getElementById("hint");
    const saveBtn = document.getElementById("saveBtn");

    function setMsg(t){ msg.textContent = t || ""; }
    function setHint(t){
      hint.style.display = t ? "block" : "none";
      hint.textContent = t || "";
    }
    function setBusy(b){
      saveBtn.disabled = b;
      document.getElementById("newPass").disabled = b;
      document.getElementById("newPass2").disabled = b;
    }

    function hasRecoveryHash(){
      // Supabase recovery link usually contains #access_token=...&type=recovery
      return typeof window.location.hash === "string" && window.location.hash.includes("access_token=");
    }

    async function ensureRecoverySession(){
      // If supabase.js is loaded correctly, onlypawsClient should exist
      if (typeof onlypawsClient === "undefined") {
        setMsg("‚ùå onlypawsClient not found. Check supabase.js path + script order.");
        return false;
      }

      // If link has tokens, Supabase v2 can pick them up if detectSessionInUrl=true
      // (you already set it in supabase.js). Give it a moment.
      const { data } = await onlypawsClient.auth.getSession();
      if (data?.session) return true;

      // If no session but hash has tokens, sometimes INITIAL_SESSION arrives slightly later
      // We'll wait a bit and re-check.
      await new Promise(r => setTimeout(r, 500));
      const { data: data2 } = await onlypawsClient.auth.getSession();
      if (data2?.session) return true;

      return false;
    }

    // Show a small hint if user opened this page without a proper recovery link
    (async () => {
      setBusy(true);
      try{
        if(!hasRecoveryHash()){
          setHint("Tip: open this page from the reset email link (it contains a token in the URL).");
        } else {
          setHint("Looks like a valid reset link. You can set a new password now.");
        }

        // This also helps if Supabase emits INITIAL_SESSION
        onlypawsClient.auth.onAuthStateChange((event) => {
          if(event === "SIGNED_IN" || event === "INITIAL_SESSION"){
            // Remove hash tokens from URL (safer + cleaner)
            try{
              if(window.location.hash){
                history.replaceState(null, document.title, window.location.pathname + window.location.search);
              }
            }catch(e){}
          }
        });

        const ok = await ensureRecoverySession();
        if(!ok){
          setMsg("‚ö†Ô∏è Invalid or expired reset link.\nGo back and request a new one.");
        } else {
          setMsg("");
        }
      } finally {
        setBusy(false);
      }
    })();

    saveBtn.addEventListener("click", async () => {
      const p1 = document.getElementById("newPass").value || "";
      const p2 = document.getElementById("newPass2").value || "";

      if(p1.length < 6){ setMsg("Password must be at least 6 characters."); return; }
      if(p1 !== p2){ setMsg("Passwords do not match."); return; }

      setBusy(true);
      try{
        setMsg("Checking link‚Ä¶");
        const ok = await ensureRecoverySession();
        if(!ok){
          setMsg("‚ö†Ô∏è Invalid or expired reset link.\nPlease request a new reset email.");
          return;
        }

        setMsg("Updating password‚Ä¶");
        const { error } = await onlypawsClient.auth.updateUser({ password: p1 });
        if(error){
          setMsg("‚ùå " + error.message);
          return;
        }

        setMsg("‚úÖ Password updated! Redirecting‚Ä¶");
        setTimeout(() => { window.location.href = "profile.html"; }, 900);
      } finally {
        setBusy(false);
      }
    });
  </script>
</body>
</html>